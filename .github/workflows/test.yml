name: Tests Automatizados

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
    workflow_dispatch: # Permite ejecuciÃ³n manual

env:
    NODE_VERSION: "22"

jobs:
    test-e2e:
        name: ğŸ­ E2E Tests (Cucumber + Screenplay)
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: ğŸ“¦ Install dependencies
              run: npm ci

            - name: ğŸ­ Install Playwright browsers
              run: npx playwright install --with-deps chromium

            - name: ğŸ§ª Run E2E tests
              run: npm run test:e2e
              env:
                  BASE_URL: https://www.saucedemo.com
                  STANDARD_USER: standard_user
                  STANDARD_PASSWORD: secret_sauce
                  LOCKED_USER: locked_out_user

            - name: ğŸ“Š Upload Cucumber Report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: cucumber-report
                  path: reports/cucumber-report.html
                  retention-days: 30

            - name: ğŸ¥ Upload test videos
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: test-videos
                  path: reports/videos/
                  retention-days: 7

    test-api:
        name: ğŸ”Œ API Tests
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: ğŸ“¦ Install dependencies
              run: npm ci

            - name: ğŸ§ª Run API tests
              run: npm run test:api
              env:
                  API_BASE_URL: https://dummyjson.com
                  API_USER_1: emilys
                  API_PASSWORD_1: emilyspass
                  API_USER_2: michaelw
                  API_PASSWORD_2: michaelwpass
                  API_USER_3: sophiab
                  API_PASSWORD_3: sophiabpass

            - name: ğŸ“Š Upload Playwright HTML Report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: reports/playwright-html/
                  retention-days: 30

    test-all:
        name: âœ… All Tests Status
        runs-on: ubuntu-latest
        needs: [test-e2e, test-api]
        if: always()

        steps:
            - name: âœ… Check test results
              run: |
                  echo "E2E Tests: ${{ needs.test-e2e.result }}"
                  echo "API Tests: ${{ needs.test-api.result }}"

                  if [[ "${{ needs.test-e2e.result }}" == "success" && "${{ needs.test-api.result }}" == "success" ]]; then
                    echo "âœ… All tests passed successfully!"
                    exit 0
                  else
                    echo "âŒ Some tests failed"
                    echo "E2E: ${{ needs.test-e2e.result }}"
                    echo "API: ${{ needs.test-api.result }}"
                    exit 1
                  fi
